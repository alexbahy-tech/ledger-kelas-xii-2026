<script>
/**
 * ============================================================
 * SISTEM MANAJEMEN AKADEMIK SMK — CLIENT SCRIPT
 * File     : Script.html
 * Version  : 2.0.0
 * Desc     : Semua logika client-side: fetch, render, CRUD,
 *            table, modal, pagination, dark mode, export
 * ============================================================
 */

'use strict';

/* ─── KONSTANTA KELAS & PRODI ───────────────────────────────── */
const KELAS_LIST = ['XIIAKL', 'XIIPMS', 'XIIMPLB', 'XIITJKT', 'XIITK', 'XIIULP'];

const PRODI_KELAS_MAP = {
  'Akuntansi dan Keuangan Lembaga'              : ['XIIAKL'],
  'Pemasaran'                                   : ['XIIPMS'],
  'Manajemen Perkantoran dan Layanan Bisnis'    : ['XIIMPLB'],
  'Teknik Jaringan Komputer dan Telekomunikasi' : ['XIITJKT'],
  'Teknik Ketenagalistrikan'                    : ['XIITK'],
  'Usaha Layanan Pariwisata'                    : ['XIIULP'],
};

/* ─── STATE MANAGEMENT ──────────────────────────────────────── */
const State = {
  allData       : [],
  filteredData  : [],
  sortCol       : 'no',
  sortDir       : 'asc',
  currentPage   : 1,
  perPage       : 25,
  filterKelas   : '',
  filterProdi   : '',
  searchQuery   : '',
  headers       : null,
  isDark        : false,
  isLoading     : false,
};

/* ─── DOM SHORTCUTS ─────────────────────────────────────────── */
const $ = (id) => document.getElementById(id);
const $$ = (sel) => document.querySelectorAll(sel);


/* ═══════════════════════════════════════════════════════════════
   INITIALIZATION
═══════════════════════════════════════════════════════════════ */
document.addEventListener('DOMContentLoaded', () => {
  App.init();
});

const App = {

  init() {
    App.loadHeaders();
    App.loadAllData();
    App.bindEvents();
    App.loadDarkModePreference();
  },

  bindEvents() {
    $$('.nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const view = item.dataset.view;
        if (view) App.switchView(view);
      });
    });

    $('sidebarToggle')?.addEventListener('click', () => {
      $('sidebar').classList.toggle('collapsed');
    });

    $('sidebarOpen')?.addEventListener('click', () => {
      $('sidebar').classList.toggle('mobile-open');
    });

    $('globalSearch')?.addEventListener('input', (e) => {
      const q = e.target.value.trim();
      State.searchQuery = q;
      $('tableSearch').value = q;
      Table.applyFilters();
      App.switchView('data-siswa');
    });

    $('refreshDataBtn')?.addEventListener('click', () => {
      App.loadAllData(true);
    });

    $('darkModeToggle')?.addEventListener('click', App.toggleDarkMode);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        App.closeModal();
        App.closeConfirm();
        App.closeDetail();
      }
    });
  },

  loadHeaders() {
    google.script.run
      .withSuccessHandler((res) => {
        if (res.success) State.headers = res.data;
      })
      .withFailureHandler((err) => {
        console.warn('Headers load error:', err);
      })
      .getHeaders();
  },

  loadAllData(isRefresh = false) {
    if (State.isLoading) return;
    State.isLoading = true;

    if (isRefresh) {
      Toast.show('Memuat ulang data dari spreadsheet...', 'info');
      App.setTableLoading(true);
    }

    google.script.run
      .withSuccessHandler((res) => {
        State.isLoading = false;
        if (res.success) {
          State.allData = res.data;
          App.onDataLoaded();
          if (isRefresh) Toast.show(`Data berhasil dimuat: ${res.data.length} siswa`, 'success');
        } else {
          App.onDataError(res.error);
        }
      })
      .withFailureHandler((err) => {
        State.isLoading = false;
        App.onDataError(err.message || 'Gagal mengambil data dari server');
      })
      .getAllData();

    App.loadStats();
  },

  onDataLoaded() {
    const loader = $('appLoader');
    loader.classList.add('fade-out');
    setTimeout(() => { loader.style.display = 'none'; }, 400);

    $('appShell').classList.remove('hidden');

    App.populateFilters();
    Table.applyFilters();
    Nilai.populateFilterKelas();
    Rekap.render();
    AuditLog.load();
    App.setTableLoading(false);
  },

  onDataError(msg) {
    $('appLoader').style.display = 'none';
    $('appShell').classList.remove('hidden');
    Toast.show(`Error: ${msg}`, 'error');
    console.error('Data load error:', msg);
  },

  loadStats() {
    google.script.run
      .withSuccessHandler((res) => {
        if (res.success) Dashboard.renderStats(res.data);
      })
      .withFailureHandler(() => {})
      .getSummaryStats();
  },

  populateFilters() {
    const filterKelasEls = ['filterKelas', 'nilaiFilterKelas'];
    filterKelasEls.forEach(id => {
      const el = $(id);
      if (!el) return;
      const val = el.value;
      el.innerHTML = id === 'nilaiFilterKelas'
        ? '<option value="">Pilih Kelas...</option>'
        : '<option value="">Semua Kelas</option>';
      KELAS_LIST.forEach(k => {
        const opt = document.createElement('option');
        opt.value = k; opt.textContent = k;
        el.appendChild(opt);
      });
      el.value = val;
    });

    const filterProdiEl = $('filterProdi');
    if (filterProdiEl) {
      const val = filterProdiEl.value;
      const prodiSet = new Set(State.allData.map(s => s.prodi).filter(Boolean));
      filterProdiEl.innerHTML = '<option value="">Semua Prodi</option>';
      Object.keys(PRODI_KELAS_MAP).forEach(p => {
        if (!prodiSet.has(p)) return;
        const opt = document.createElement('option');
        opt.value = p; opt.textContent = p;
        filterProdiEl.appendChild(opt);
      });
      filterProdiEl.value = val;
    }
  },

  setTableLoading(isLoad) {
    const tbody = $('tableBody');
    if (!tbody) return;
    if (isLoad) {
      tbody.innerHTML = `<tr><td colspan="7" class="table-empty">
        <span class="material-icons-round" style="animation:spin 1s linear infinite">sync</span>
        <p>Memuat data...</p>
      </td></tr>`;
    }
  },

  switchView(viewName) {
    $$('.view').forEach(v => v.classList.remove('active'));
    $$('.nav-item').forEach(n => n.classList.remove('active'));

    const targetView = $(`view-${viewName}`);
    const targetNav  = document.querySelector(`[data-view="${viewName}"]`);

    if (targetView) targetView.classList.add('active');
    if (targetNav)  targetNav.classList.add('active');

    const labels = {
      'dashboard'      : 'Dashboard',
      'data-siswa'     : 'Data Siswa',
      'nilai-semester' : 'Nilai Semester',
      'rekap-prodi'    : 'Rekap per Program Keahlian',
      'audit-log'      : 'Audit Log',
    };

    $('breadcrumbText').textContent = labels[viewName] || viewName;
    $('sidebar').classList.remove('mobile-open');

    if (viewName === 'audit-log') AuditLog.load();
    if (viewName === 'rekap-prodi') Rekap.render();
  },

  openModal(mode, rowData = null) {
    const modal  = $('modalOverlay');
    const title  = $('modalTitle');
    const btnTxt = $('submitBtnText');

    if (mode === 'add') {
      title.textContent  = 'Tambah Siswa Baru';
      btnTxt.textContent = 'Simpan Data';
      Modal.resetForm();
    } else if (mode === 'edit' && rowData) {
      title.textContent  = 'Edit Data Siswa';
      btnTxt.textContent = 'Simpan Perubahan';
      Modal.fillForm(rowData);
    }

    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    setTimeout(() => $('formNIS')?.focus(), 50);
  },

  closeModal() {
    $('modalOverlay').classList.add('hidden');
    document.body.style.overflow = '';
  },

  closeModalOutside(e) {
    if (e.target === $('modalOverlay')) App.closeModal();
  },

  async submitForm() {
    if (!Modal.validate()) return;

    const payload = Modal.collectFormData();
    const isEdit  = !!payload._rowIndex;

    const btn  = $('submitFormBtn');
    const orig = btn.innerHTML;
    btn.innerHTML = '<span class="material-icons-round" style="animation:spin 1s linear infinite">sync</span><span>Menyimpan...</span>';
    btn.disabled = true;

    const fn = isEdit ? 'updateRow' : 'addRow';

    google.script.run
      .withSuccessHandler((res) => {
        btn.innerHTML = orig;
        btn.disabled  = false;

        if (res.success) {
          App.closeModal();
          Toast.show(isEdit ? 'Data siswa berhasil diperbarui.' : 'Siswa baru berhasil ditambahkan.', 'success');
          App.loadAllData(false);
        } else {
          Toast.show(`Gagal menyimpan: ${res.error}`, 'error');
        }
      })
      .withFailureHandler((err) => {
        btn.innerHTML = orig;
        btn.disabled  = false;
        Toast.show(`Error server: ${err.message}`, 'error');
      })
      [fn](payload);
  },

  openConfirm(rowIndex, namasSiswa) {
    $('confirmMessage').textContent = `Data "${namasSiswa}" akan dihapus permanen.`;
    const overlay = $('confirmOverlay');
    overlay.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    $('confirmOkBtn').onclick = () => {
      App.closeConfirm();
      App.doDelete(rowIndex, namasSiswa);
    };
  },

  closeConfirm() {
    $('confirmOverlay').classList.add('hidden');
    document.body.style.overflow = '';
  },

  doDelete(rowIndex, namaSiswa) {
    Toast.show('Menghapus data...', 'info');

    google.script.run
      .withSuccessHandler((res) => {
        if (res.success) {
          Toast.show(`Data "${namaSiswa}" berhasil dihapus.`, 'success');
          App.loadAllData(false);
        } else {
          Toast.show(`Gagal hapus: ${res.error}`, 'error');
        }
      })
      .withFailureHandler((err) => {
        Toast.show(`Error: ${err.message}`, 'error');
      })
      .deleteRow(rowIndex, namaSiswa);
  },

  openDetail(rowIndex) {
    const siswa = State.allData.find(s => s._rowIndex === rowIndex);
    if (!siswa) return;

    $('detailTitle').textContent = siswa.nama;
    $('detailBody').innerHTML = Detail.buildHTML(siswa);
    $('detailOverlay').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  },

  closeDetail() {
    $('detailOverlay').classList.add('hidden');
    document.body.style.overflow = '';
  },

  closeDetailOutside(e) {
    if (e.target === $('detailOverlay')) App.closeDetail();
  },

  toggleDarkMode() {
    State.isDark = !State.isDark;
    document.body.setAttribute('data-theme', State.isDark ? 'dark' : 'light');
    $('darkModeIcon').textContent  = State.isDark ? 'light_mode' : 'dark_mode';
    $('darkModeLabel').textContent = State.isDark ? 'Mode Terang' : 'Mode Gelap';
    localStorage?.setItem?.('smk-dark-mode', State.isDark ? '1' : '0');
  },

  loadDarkModePreference() {
    try {
      if (localStorage?.getItem?.('smk-dark-mode') === '1') App.toggleDarkMode();
    } catch (e) {}
  },

  exportExcel() {
    if (!State.filteredData.length) {
      Toast.show('Tidak ada data untuk diekspor.', 'warning');
      return;
    }

    const headers = ['No','NIS','NISN','Nama Siswa','Program Keahlian','Kelas'];
    const rows    = State.filteredData.map(s =>
      [s.no, s.nis, s.nisn, s.nama, s.prodi, s.kelas]
        .map(v => `"${String(v || '').replace(/"/g, '""')}"`)
        .join(',')
    );

    const csv  = [headers.join(','), ...rows].join('\n');
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = `ledger-nilai-xii-${Date.now()}.csv`;
    a.click();
    URL.revokeObjectURL(url);

    Toast.show(`Export berhasil: ${State.filteredData.length} baris`, 'success');
  },
};


/* ═══════════════════════════════════════════════════════════════
   TABLE MODULE
═══════════════════════════════════════════════════════════════ */
const Table = {

  onSearch(q) {
    State.searchQuery = q.toLowerCase().trim();
    State.currentPage = 1;
    Table.applyFilters();
  },

  onFilterKelas(val) {
    State.filterKelas = val;
    State.currentPage = 1;
    Table.applyFilters();
  },

  onFilterProdi(val) {
    State.filterProdi = val;
    State.currentPage = 1;
    Table.applyFilters();
  },

  clearFilters() {
    State.searchQuery = '';
    State.filterKelas = '';
    State.filterProdi = '';
    State.currentPage = 1;
    $('tableSearch').value  = '';
    $('filterKelas').value  = '';
    $('filterProdi').value  = '';
    $('globalSearch').value = '';
    Table.applyFilters();
  },

  applyFilters() {
    let data = [...State.allData];

    if (State.filterKelas)  data = data.filter(s => s.kelas  === State.filterKelas);
    if (State.filterProdi)  data = data.filter(s => s.prodi  === State.filterProdi);

    if (State.searchQuery) {
      const q = State.searchQuery;
      data = data.filter(s =>
        (s.nama  || '').toLowerCase().includes(q) ||
        (s.nis   || '').toLowerCase().includes(q) ||
        (s.nisn  || '').toLowerCase().includes(q) ||
        (s.kelas || '').toLowerCase().includes(q) ||
        (s.prodi || '').toLowerCase().includes(q)
      );
    }

    data = Table.sortData(data, State.sortCol, State.sortDir);

    State.filteredData = data;
    $('rowCountBadge').textContent = `${data.length} data`;
    Table.renderPage();
  },

  sortData(data, col, dir) {
    return [...data].sort((a, b) => {
      let va = a[col] ?? '';
      let vb = b[col] ?? '';
      if (typeof va === 'string') va = va.toLowerCase();
      if (typeof vb === 'string') vb = vb.toLowerCase();
      if (va < vb) return dir === 'asc' ? -1 : 1;
      if (va > vb) return dir === 'asc' ? 1 : -1;
      return 0;
    });
  },

  sortBy(col) {
    if (State.sortCol === col) {
      State.sortDir = State.sortDir === 'asc' ? 'desc' : 'asc';
    } else {
      State.sortCol = col;
      State.sortDir = 'asc';
    }

    $$('.data-table th.sortable').forEach(th => {
      th.classList.remove('sort-asc', 'sort-desc');
      if (th.dataset.col === col) {
        th.classList.add(State.sortDir === 'asc' ? 'sort-asc' : 'sort-desc');
        th.querySelector('.sort-icon').textContent =
          State.sortDir === 'asc' ? 'arrow_upward' : 'arrow_downward';
      } else {
        const icon = th.querySelector('.sort-icon');
        if (icon) icon.textContent = 'unfold_more';
      }
    });

    Table.applyFilters();
  },

  renderPage() {
    const { filteredData, currentPage, perPage } = State;
    const totalPages = Math.max(1, Math.ceil(filteredData.length / perPage));
    State.currentPage = Math.min(currentPage, totalPages);

    const start  = (State.currentPage - 1) * perPage;
    const end    = start + perPage;
    const page   = filteredData.slice(start, end);

    Table.renderRows(page, start);
    Table.renderPagination(totalPages);

    $('paginationInfo').textContent =
      filteredData.length
        ? `Menampilkan ${start + 1}–${Math.min(end, filteredData.length)} dari ${filteredData.length}`
        : '';
  },

  renderRows(rows, offset) {
    const tbody = $('tableBody');

    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="7" class="table-empty">
        <span class="material-icons-round">search_off</span>
        <p>Tidak ada data yang cocok dengan filter pencarian.</p>
      </td></tr>`;
      return;
    }

    const fragment = document.createDocumentFragment();

    rows.forEach((s, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="text-muted text-sm">${offset + i + 1}</td>
        <td class="cell-nis font-mono">${s.nis || '—'}</td>
        <td class="text-muted text-sm font-mono">${s.nisn || '—'}</td>
        <td><span class="cell-nama">${Table.highlight(s.nama, State.searchQuery)}</span></td>
        <td><span class="cell-prodi" title="${s.prodi}">${s.prodi || '—'}</span></td>
        <td><span class="cell-kelas">${s.kelas || '—'}</span></td>
        <td class="td-aksi">
          <div class="action-group">
            <button class="btn-sm btn-detail" onclick="App.openDetail(${s._rowIndex})" title="Lihat nilai lengkap">
              <span class="material-icons-round">visibility</span> Detail
            </button>
            <button class="btn-sm btn-edit" onclick="App.openModal('edit', ${JSON.stringify(s).replace(/"/g, '&quot;')})" title="Edit data">
              <span class="material-icons-round">edit</span>
            </button>
            <button class="btn-sm btn-delete" onclick="App.openConfirm(${s._rowIndex}, '${s.nama.replace(/'/g, "\\'")}')" title="Hapus data">
              <span class="material-icons-round">delete</span>
            </button>
          </div>
        </td>
      `;
      fragment.appendChild(tr);
    });

    tbody.innerHTML = '';
    tbody.appendChild(fragment);
  },

  highlight(text, query) {
    if (!query || !text) return text || '—';
    const re = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(re, '<mark style="background:var(--primary-light);color:var(--primary);padding:0 2px;border-radius:2px;">$1</mark>');
  },

  renderPagination(totalPages) {
    const { currentPage } = State;

    $('prevPage').disabled = currentPage <= 1;
    $('nextPage').disabled = currentPage >= totalPages;

    const container = $('pageNumbers');
    container.innerHTML = '';

    const pages = Table.getPageRange(currentPage, totalPages);

    pages.forEach(p => {
      if (p === '...') {
        const span = document.createElement('span');
        span.textContent = '…';
        span.className = 'text-muted';
        span.style.padding = '0 4px';
        container.appendChild(span);
      } else {
        const btn = document.createElement('button');
        btn.textContent = p;
        btn.className   = `page-btn${p === currentPage ? ' active' : ''}`;
        btn.onclick     = () => { State.currentPage = p; Table.renderPage(); };
        container.appendChild(btn);
      }
    });
  },

  getPageRange(current, total) {
    if (total <= 7) return Array.from({ length: total }, (_, i) => i + 1);
    if (current <= 4) return [1, 2, 3, 4, 5, '...', total];
    if (current >= total - 3) return [1, '...', total-4, total-3, total-2, total-1, total];
    return [1, '...', current-1, current, current+1, '...', total];
  },

  prevPage() {
    if (State.currentPage > 1) { State.currentPage--; Table.renderPage(); }
  },

  nextPage() {
    const total = Math.ceil(State.filteredData.length / State.perPage);
    if (State.currentPage < total) { State.currentPage++; Table.renderPage(); }
  },

  setPerPage(val) {
    State.perPage     = Number(val);
    State.currentPage = 1;
    Table.renderPage();
  },
};


/* ═══════════════════════════════════════════════════════════════
   MODAL MODULE
═══════════════════════════════════════════════════════════════ */
const Modal = {

  MAPEL: {
    1: ['Pend. Agama','Pend. Pancasila','Bhs. Indonesia','PJOK','Sejarah','Mulok','Seni Budaya','Matematika','Bhs. Inggris','Informatika','Projek IPAS','DPK','Rata-Rata'],
    2: ['Pend. Agama','Pend. Pancasila','Bhs. Indonesia','PJOK','Sejarah','Mulok','Seni Budaya','Matematika','Bhs. Inggris','Informatika','Projek IPAS','DPK','Rata-Rata'],
    3: ['Pend. Agama','Pend. Pancasila','Bhs. Indonesia','PJOK','Sejarah','Mulok','Matematika','Bhs. Inggris','KK','PKK','Mapel Pilihan','Rata-Rata'],
    4: ['Pend. Agama','Pend. Pancasila','Bhs. Indonesia','PJOK','Sejarah','Mulok','Matematika','Bhs. Inggris','KK','PKK','Mapel Pilihan','Rata-Rata'],
    5: ['Pend. Agama','Pend. Pancasila','Bhs. Indonesia','Mulok','Matematika','Bhs. Inggris','KK','PKK','Mapel Pilihan','Rata-Rata'],
    6: ['Pend. Agama','Pend. Pancasila','Bhs. Indonesia','Mulok','Matematika','Bhs. Inggris','KK','PKK','Mapel Pilihan','Rata-Rata'],
  },

  currentSemTab: 1,

  onProdiChange(prodiVal) {
    const kelasSelect = $('formKelas');
    const currentVal  = kelasSelect.value;

    kelasSelect.innerHTML = '<option value="">— Pilih Kelas —</option>';

    const kelasList = prodiVal
      ? (PRODI_KELAS_MAP[prodiVal] || KELAS_LIST)
      : KELAS_LIST;

    kelasList.forEach(k => {
      const opt = document.createElement('option');
      opt.value = k; opt.textContent = k;
      kelasSelect.appendChild(opt);
    });

    if (kelasList.includes(currentVal)) kelasSelect.value = currentVal;
  },

  resetForm() {
    $('siswaForm').reset();
    $('formRowIndex').value = '';
    $('formNo').value       = '';
    Modal.clearErrors();
    Modal.renderSemesterFields(1);
    Modal.switchSemTab(1);
  },

  fillForm(data) {
    $('formRowIndex').value = data._rowIndex || '';
    $('formNo').value       = data.no        || '';
    $('formNIS').value      = data.nis        || '';
    $('formNISN').value     = data.nisn       || '';
    $('formNama').value     = data.nama       || '';
    $('formProdi').value    = data.prodi      || '';

    Modal.onProdiChange(data.prodi || '');
    $('formKelas').value    = data.kelas      || '';

    Modal.clearErrors();
    Modal.renderSemesterFields(1, data);
    Modal.switchSemTab(1);
  },

  renderSemesterFields(semNum, data = null) {
    const mapel = Modal.MAPEL[semNum] || [];
    const semKey = `semester${semNum}`;
    const semData = data ? (data[semKey] || {}) : {};

    const container = $('semesterFieldsContainer');
    container.innerHTML = '';

    const grid = document.createElement('div');
    grid.className = 'semester-fields';

    mapel.forEach(m => {
      const isRata = m === 'Rata-Rata';
      const div    = document.createElement('div');
      div.className = 'form-group';

      const label  = document.createElement('label');
      label.textContent = m;

      const input  = document.createElement('input');
      input.type   = 'number';
      input.min    = '0';
      input.max    = '100';
      input.step   = '0.01';
      input.placeholder = '0–100';
      input.id     = `sem${semNum}_${m.replace(/[^a-zA-Z0-9]/g, '_')}`;
      input.dataset.mapel = m;
      input.dataset.sem   = semNum;
      if (isRata) input.readOnly = true;

      const existingVal = semData[m];
      if (existingVal !== null && existingVal !== undefined) {
        input.value = existingVal;
      }

      div.appendChild(label);
      div.appendChild(input);
      grid.appendChild(div);
    });

    container.appendChild(grid);
  },

  switchSemTab(semNum) {
    const rowIdx = $('formRowIndex').value;
    const data   = rowIdx
      ? State.allData.find(s => s._rowIndex === Number(rowIdx))
      : null;

    Modal.currentSemTab = semNum;
    $$('.sem-tab').forEach(t => t.classList.toggle('active', Number(t.dataset.sem) === semNum));
    Modal.renderSemesterFields(semNum, data);
  },

  validate() {
    Modal.clearErrors();
    let valid = true;

    const nis   = $('formNIS').value.trim();
    const nama  = $('formNama').value.trim();
    const kelas = $('formKelas').value.trim();

    if (!nis) {
      $('errNIS').textContent = 'NIS wajib diisi';
      $('formNIS').classList.add('error');
      valid = false;
    }

    if (!nama) {
      $('errNama').textContent = 'Nama siswa wajib diisi';
      $('formNama').classList.add('error');
      valid = false;
    }

    if (!kelas) {
      $('errKelas').textContent = 'Kelas wajib diisi';
      $('formKelas').classList.add('error');
      valid = false;
    }

    if (!valid) Toast.show('Harap lengkapi field yang diperlukan.', 'warning');
    return valid;
  },

  clearErrors() {
    ['errNIS','errNama','errKelas','errProdi'].forEach(id => {
      const el = $(id);
      if (el) el.textContent = '';
    });
    $$('#siswaForm .error').forEach(el => el.classList.remove('error'));
  },

  collectFormData() {
    const payload = {
      _rowIndex : Number($('formRowIndex').value) || null,
      no        : Number($('formNo').value) || null,
      nis       : $('formNIS').value.trim(),
      nisn      : $('formNISN').value.trim(),
      nama      : $('formNama').value.trim(),
      prodi     : $('formProdi').value,
      kelas     : $('formKelas').value.trim(),
    };

    const rowIdx  = payload._rowIndex;
    const existing = rowIdx ? State.allData.find(s => s._rowIndex === rowIdx) : {};

    for (let sem = 1; sem <= 6; sem++) {
      const semKey  = `semester${sem}`;
      const semData = { ...((existing || {})[semKey] || {}) };

      const inputs = $$(`[data-sem="${sem}"]`);
      inputs.forEach(inp => {
        if (inp.value !== '') {
          semData[inp.dataset.mapel] = parseFloat(inp.value) || 0;
        }
      });

      payload[semKey] = semData;
    }

    return payload;
  },
};


/* ═══════════════════════════════════════════════════════════════
   DASHBOARD MODULE
═══════════════════════════════════════════════════════════════ */
const Dashboard = {

  renderStats(stats) {
    $('statTotalSiswa').textContent = stats.totalSiswa;
    $('statTotalProdi').textContent = stats.totalProdi;
    $('statTotalKelas').textContent = stats.totalKelas;

    Dashboard.renderBreakdown('prodiBreakdown', stats.prodiBreakdown, 'nama', stats.totalSiswa);
    Dashboard.renderBreakdown('kelasBreakdown', stats.kelasBreakdown, 'kelas', stats.totalSiswa);
  },

  renderBreakdown(containerId, items, labelKey, total) {
    const container = $(containerId);
    if (!container || !items) return;

    const sorted = [...items].sort((a, b) => b.jumlah - a.jumlah);

    container.innerHTML = sorted.map(item => {
      const pct = total > 0 ? Math.round((item.jumlah / total) * 100) : 0;
      return `
        <div class="breakdown-item">
          <div class="breakdown-bar-wrap">
            <div class="breakdown-label" title="${item[labelKey]}">${item[labelKey]}</div>
            <div class="breakdown-bar">
              <div class="breakdown-fill" style="width: ${pct}%"></div>
            </div>
          </div>
          <span class="breakdown-count">${item.jumlah}</span>
        </div>`;
    }).join('');
  },
};


/* ═══════════════════════════════════════════════════════════════
   NILAI SEMESTER VIEW
═══════════════════════════════════════════════════════════════ */
const Nilai = {

  populateFilterKelas() {
    const el = $('nilaiFilterKelas');
    if (!el) return;
    const kelasSet = new Set(State.allData.map(s => s.kelas).filter(Boolean).sort());
    el.innerHTML = '<option value="">Pilih Kelas...</option>';
    kelasSet.forEach(k => {
      const opt = document.createElement('option');
      opt.value = k; opt.textContent = k;
      el.appendChild(opt);
    });
  },

  onFilterChange() {
    const kelas = $('nilaiFilterKelas').value;
    const sem   = Number($('nilaiSemester').value);
    Nilai.render(kelas, sem);
  },

  render(kelas, sem) {
    const wrapper = $('nilaiTableWrapper');

    if (!kelas) {
      wrapper.innerHTML = '<p class="table-empty"><span class="material-icons-round">info</span><span>Pilih kelas untuk menampilkan nilai.</span></p>';
      return;
    }

    const data = State.allData.filter(s => s.kelas === kelas);
    if (!data.length) {
      wrapper.innerHTML = '<p class="table-empty"><span class="material-icons-round">info</span><span>Tidak ada siswa di kelas ini.</span></p>';
      return;
    }

    const semKey = `semester${sem}`;
    const mapel  = Modal.MAPEL[sem] || [];

    const headerCols = mapel.map(m =>
      `<th class="${m === 'Nama Siswa' ? 'th-nama' : ''}">${m}</th>`
    ).join('');

    const rows = data.map(s => {
      const semData = s[semKey] || {};
      const cols = mapel.map(m => {
        const v = semData[m];
        if (v === null || v === undefined || v === '') return '<td><span class="score-empty">—</span></td>';
        const cls = v >= 75 ? 'score-high' : v >= 60 ? 'score-mid' : 'score-low';
        return `<td><span class="score-chip ${cls}">${v}</span></td>`;
      }).join('');
      return `<tr>
        <td class="cell-nama">${s.nama}</td>
        <td><span class="cell-kelas">${s.kelas}</span></td>
        ${cols}
      </tr>`;
    }).join('');

    wrapper.innerHTML = `
      <table class="data-table nilai-table">
        <thead>
          <tr>
            <th class="th-nama">Nama Siswa</th>
            <th class="th-kelas">Kelas</th>
            ${headerCols}
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;
  },
};


/* ═══════════════════════════════════════════════════════════════
   REKAP PRODI VIEW
═══════════════════════════════════════════════════════════════ */
const Rekap = {
  render() {
    const container = $('rekapProdiContent');
    if (!container || !State.allData.length) return;

    const prodiMap = {};
    State.allData.forEach(s => {
      if (!prodiMap[s.prodi]) prodiMap[s.prodi] = {};
      const kelas = s.kelas || 'Tidak Diketahui';
      prodiMap[s.prodi][kelas] = (prodiMap[s.prodi][kelas] || 0) + 1;
    });

    container.innerHTML = Object.entries(prodiMap)
      .sort(([a], [b]) => a.localeCompare(b))
      .map(([prodi, kelasMap]) => {
        const total = Object.values(kelasMap).reduce((a, b) => a + b, 0);
        const kelasList = Object.entries(kelasMap)
          .sort(([a], [b]) => a.localeCompare(b))
          .map(([kelas, count]) => `
            <div class="rekap-kelas-item">
              <span class="rekap-kelas-name">${kelas}</span>
              <span class="rekap-kelas-count">${count} siswa</span>
            </div>`).join('');

        return `
          <div class="rekap-card">
            <div class="rekap-card-header">
              <span>${prodi}</span>
              <span class="rekap-badge">${total} siswa</span>
            </div>
            <div class="rekap-kelas-list">${kelasList}</div>
          </div>`;
      }).join('');
  },
};


/* ═══════════════════════════════════════════════════════════════
   AUDIT LOG VIEW
═══════════════════════════════════════════════════════════════ */
const AuditLog = {
  loaded: false,

  load() {
    if (AuditLog.loaded) return;
    AuditLog.loaded = true;

    google.script.run
      .withSuccessHandler((res) => {
        if (res.success) AuditLog.render(res.data);
      })
      .withFailureHandler(() => {
        $('auditLogBody').innerHTML = '<tr><td colspan="5" class="table-empty"><span class="material-icons-round">error_outline</span><p>Gagal memuat audit log.</p></td></tr>';
      })
      .getAuditLog();
  },

  render(entries) {
    const tbody = $('auditLogBody');
    if (!entries || !entries.length) {
      tbody.innerHTML = '<tr><td colspan="5" class="table-empty"><span class="material-icons-round">info</span><p>Belum ada riwayat perubahan.</p></td></tr>';
      return;
    }

    tbody.innerHTML = entries.map(e => `
      <tr>
        <td class="text-sm text-muted font-mono">${e.timestamp}</td>
        <td><span class="audit-action audit-${e.action}">${e.action}</span></td>
        <td class="text-sm">${e.rowRef}</td>
        <td class="text-sm text-muted">${e.user}</td>
        <td>${e.detail}</td>
      </tr>`).join('');
  },
};


/* ═══════════════════════════════════════════════════════════════
   DETAIL NILAI MODULE
═══════════════════════════════════════════════════════════════ */
const Detail = {

  buildHTML(siswa) {
    const initial = (siswa.nama || 'S').split(' ').slice(0,2).map(w => w[0]).join('').toUpperCase();

    const semesterBlocks = [1,2,3,4,5,6].map(sem => {
      const semKey = `semester${sem}`;
      const data   = siswa[semKey] || {};
      const mapel  = Modal.MAPEL[sem] || [];

      const hasData = mapel.some(m => data[m] !== null && data[m] !== undefined);
      if (!hasData) return '';

      const items = mapel.map(m => {
        const v = data[m];
        const isRata = m === 'Rata-Rata';
        if (v === null || v === undefined) return '';
        return `
          <div class="detail-nilai-item ${isRata ? 'is-rata' : ''}">
            <span class="detail-nilai-mapel">${m}</span>
            <span class="detail-nilai-skor">${v}</span>
          </div>`;
      }).filter(Boolean).join('');

      if (!items) return '';

      return `
        <div class="detail-semester-block">
          <div class="detail-semester-title">
            <span class="material-icons-round" style="font-size:16px;color:var(--primary)">school</span>
            Semester ${sem}
          </div>
          <div class="detail-nilai-grid">${items}</div>
        </div>`;
    }).filter(Boolean).join('');

    return `
      <div class="detail-identity">
        <div class="detail-avatar">${initial}</div>
        <div>
          <div class="detail-info-nama">${siswa.nama}</div>
          <div class="detail-info-meta">NIS: ${siswa.nis || '—'} &nbsp;|&nbsp; NISN: ${siswa.nisn || '—'}</div>
          <div class="detail-info-meta">Prodi: ${siswa.prodi || '—'} &nbsp;|&nbsp; Kelas: ${siswa.kelas || '—'}</div>
        </div>
      </div>
      ${semesterBlocks || '<p class="text-muted">Belum ada data nilai untuk siswa ini.</p>'}`;
  },
};


/* ═══════════════════════════════════════════════════════════════
   TOAST NOTIFICATION MODULE
═══════════════════════════════════════════════════════════════ */
const Toast = {

  ICONS: {
    success : 'check_circle',
    error   : 'error',
    warning : 'warning',
    info    : 'info',
  },

  show(message, type = 'info', duration = 4000) {
    const container = $('toastContainer');
    const toast     = document.createElement('div');

    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
      <span class="material-icons-round">${Toast.ICONS[type] || 'info'}</span>
      <span>${message}</span>
    `;

    container.appendChild(toast);

    setTimeout(() => {
      toast.classList.add('removing');
      setTimeout(() => toast.remove(), 250);
    }, duration);

    toast.addEventListener('click', () => {
      toast.classList.add('removing');
      setTimeout(() => toast.remove(), 250);
    });
  },
};


/* ─── EXPOSE untuk inline onclick di HTML ─────────────────── */
window.App    = App;
window.Table  = Table;
window.Modal  = Modal;
window.Nilai  = Nilai;
window.Toast  = Toast;
</script>
